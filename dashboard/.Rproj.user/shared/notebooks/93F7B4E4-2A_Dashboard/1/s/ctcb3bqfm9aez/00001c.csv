"0","# Perform spatial join and aggregate"
"0","weighted_joined_df <- weight.sf %>%"
"0","  st_join(no2_sf, join = st_nearest_feature) %>%  # Join by nearest feature"
"0","  group_by(NO2) %>%  # Group by observed NO2"
"0","  summarise("
"0","    weighted_NO2 = mean(weighted.NO2, na.rm = TRUE),  # Average the predictions"
"0","    residual = mean(NO2 - weighted.NO2, na.rm = TRUE)  # Average the residuals"
"0","  ) %>%"
"0","  ungroup()  # Ungroup for clean data"
"0",""
"0","# Now create the bubble plot"
"0","bubble_weighted <- weighted_joined_df %>%"
"0","  ggplot(aes(x = NO2, y = weighted_NO2, colour = residual)) +"
"0","  geom_point(alpha = 0.5) +  # Points with transparency"
"0","  scale_color_viridis(option = 'A') +  # Viridis color scale for residuals"
"0","  theme_bw() +  # Clean theme"
"0","  labs(title = ""Bubble Plot of Weighted NO2 Residuals"","
"0","       y = ""Weighted Predicted NO2"","
"0","       x = ""Observed NO2"","
"0","       colour = ""Residual"")  # Labels"
"0",""
"0","# Print the plot"
"0","print(bubble_weighted)"
